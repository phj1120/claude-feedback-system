#!/bin/bash
###
### Stop Hook - Claude ì‘ë‹µ ì™„ë£Œ ì‹œ CSV ì—…ë°ì´íŠ¸
###

# í”„ë¡œì íŠ¸ .claude ë””ë ‰í† ë¦¬ ê²½ë¡œ
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CLAUDE_DIR="$(dirname "$SCRIPT_DIR")"

# ìž…ë ¥ ë°ì´í„° ì½ê¸°
INPUT=$(cat)

# ë””ë²„ê¹…: ìž…ë ¥ ë°ì´í„° ë¡œê·¸
{
    echo "=== Stop Hook Debug Log ==="
    echo "Time: $(date '+%Y-%m-%d %H:%M:%S')"
    echo ""
    echo "Input JSON:"
    echo "$INPUT"
    echo ""
} > "$CLAUDE_DIR/logs/stop-hook-debug.log"

# ì„¸ì…˜ ì •ë³´ ë¡œë“œ
SESSION_FILE="$CLAUDE_DIR/temp/current-session.json"
if [ ! -f "$SESSION_FILE" ]; then
    # ì„¸ì…˜ ì •ë³´ê°€ ì—†ìœ¼ë©´ ì¢…ë£Œ (í”„ë¡¬í”„íŠ¸ ì œì¶œ ì—†ì´ ì‹¤í–‰ëœ ê²½ìš°)
    exit 0
fi

SESSION_ID=$(python3 -c "import json; f=open('$SESSION_FILE'); d=json.load(f); print(d['session_id'])")

# Transcript íŒŒì¼ ê²½ë¡œ ì¶”ì¶œ - ê°€ìž¥ ìµœê·¼ íŒŒì¼ì„ ì‚¬ìš©
ORIGINAL_TRANSCRIPT=$(echo "$INPUT" | python3 -c "import sys, json; data=json.load(sys.stdin); print(data.get('transcript_path', ''))" 2>/dev/null || echo "")

# ë¬´ì¡°ê±´ ê°€ìž¥ ìµœê·¼ ìˆ˜ì •ëœ transcript íŒŒì¼ ì‚¬ìš©
TRANSCRIPT_PATH=$(ls -t "$HOME/.claude/projects/-Users-parkh-Dev-git-Project-vibe-pay/"*.jsonl 2>/dev/null | head -1)

# ë””ë²„ê¹…: transcript ì •ë³´
{
    echo "Original transcript: $ORIGINAL_TRANSCRIPT"
    echo "Using transcript: $TRANSCRIPT_PATH"
    echo "File size: $(wc -c < "$TRANSCRIPT_PATH" 2>/dev/null || echo 0) bytes"
} >> "$CLAUDE_DIR/logs/stop-hook-debug.log"

# ì‘ë‹µ ë‚´ìš© ì¶”ì¶œ (transcriptì—ì„œ ë§ˆì§€ë§‰ assistant ë©”ì‹œì§€)
RESPONSE=""
TOOLS_USED=""
TOOLS_COUNT=0

if [ -n "$TRANSCRIPT_PATH" ] && [ -f "$TRANSCRIPT_PATH" ]; then
    # Python ìŠ¤í¬ë¦½íŠ¸ë¡œ transcript íŒŒì‹±
    RESPONSE=$(python3 "$SCRIPT_DIR/stop-parse-transcript.py" "$TRANSCRIPT_PATH")

    # JSON íŒŒì‹±
    CLAUDE_RESPONSE=$(echo "$RESPONSE" | python3 -c "import sys, json; d=json.load(sys.stdin); print(d.get('response', ''))")
    TOOLS_USED=$(echo "$RESPONSE" | python3 -c "import sys, json; d=json.load(sys.stdin); print(d.get('tools_used', ''))")
    TOOLS_COUNT=$(echo "$RESPONSE" | python3 -c "import sys, json; d=json.load(sys.stdin); print(d.get('tools_count', 0))")

    # ë””ë²„ê¹…: íŒŒì‹± ê²°ê³¼
    {
        echo ""
        echo "Parsed response length: ${#CLAUDE_RESPONSE}"
        echo "Response preview: ${CLAUDE_RESPONSE:0:200}"
        echo "Tools used: $TOOLS_USED"
        echo "Tools count: $TOOLS_COUNT"
    } >> "$CLAUDE_DIR/logs/stop-hook-debug.log"
fi

# ì†Œìš” ì‹œê°„ ê³„ì‚° (ëŒ€ëžµì )
START_TIME=$(python3 -c "import json; f=open('$SESSION_FILE'); d=json.load(f); print(d['timestamp'])")
END_TIME=$(date '+%Y-%m-%d %H:%M:%S')

# ì´ˆ ë‹¨ìœ„ ê³„ì‚°
DURATION=$(python3 -c "from datetime import datetime; start=datetime.strptime('$START_TIME', '%Y-%m-%d %H:%M:%S'); end=datetime.strptime('$END_TIME', '%Y-%m-%d %H:%M:%S'); print(int((end-start).total_seconds()))")

# CSV ì—…ë°ì´íŠ¸ (ì‘ë‹µ ì •ë³´)
python3 "$SCRIPT_DIR/csv-updater.py" update-response "$SESSION_ID" "$CLAUDE_RESPONSE" "$DURATION" "$TOOLS_USED" "$TOOLS_COUNT"

# í˜„ìž¬ ì‘ë‹µì˜ ì„¸ì…˜ ì •ë³´ë¥¼ SESSION_FILEì— ì €ìž¥ (ë‹¤ìŒ ë§Œì¡±ë„ í‰ê°€ë¥¼ ìœ„í•´)
cat > "$SESSION_FILE" << EOF
{
  "session_id": "$SESSION_ID",
  "timestamp": "$END_TIME",
  "project_path": "$(pwd)"
}
EOF

# í”¼ë“œë°± ì•ˆë‚´ ë©”ì‹œì§€ (JSONìœ¼ë¡œ ë°˜í™˜)
cat << 'EOFMSG'
{
  "decision": "proceed",
  "message": "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nðŸ’¡ ë§Œì¡±ë„ í‰ê°€: ë‹¤ìŒ í”„ë¡¬í”„íŠ¸ì— 1-5 ìž…ë ¥\n[1] â­ ë§¤ìš° ë³„ë¡œ [2] â­â­ ë³„ë¡œ [3] â­â­â­ ì¤‘ê°„\n[4] â­â­â­â­ ì¢‹ìŒ [5] â­â­â­â­â­ ë§¤ìš° ì¢‹ìŒ\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
}
EOFMSG

exit 0